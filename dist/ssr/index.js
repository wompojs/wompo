import{registeredComponents as O,pushRenderingContext as x,popRenderingContext as B,html as T}from"../wompo.js";const F=(()=>{const n=["",""];return n.raw=["",""],n})(),I=n=>T(F,n),J=n=>!!n?._$wompoHtml,L=n=>({props:n,hooks:[],_$effects:[],_$layoutEffects:[],_$asyncCalls:[],_$suspendedAsyncCalls:[],_$portals:[],_$usesContext:!1,_$hasBeenMoved:!1,_$measurePerf:!1,_$initialProps:n,requestRender(){},onDisconnected(){},updateProp(){}}),M=new Set(["children","styles","ref"]),K=n=>{if(!n||typeof n!="object")return!1;if(typeof Node<"u"&&n instanceof Node)return!0;const e=n;return typeof e.nodeType=="number"&&typeof e.nodeName=="string"},a=(n,e)=>{if(n===null)return null;const o=typeof n;if(o==="string"||o==="boolean")return n;if(o==="number")return Number.isFinite(n)?n:null;if(o==="bigint")return n.toString();if(!(o==="undefined"||o==="function"||o==="symbol")){if(n instanceof String||n instanceof Number||n instanceof Boolean)return a(n.valueOf(),e);if(n instanceof Date)return n.toJSON();if(n instanceof RegExp)return n.toString();if(n instanceof Error)return{name:n.name,message:n.message,stack:n.stack};if(typeof n=="object"){if(typeof n?.then=="function"||n._$wompoHtml||n._$wompoF||n._$wompoChildren)return;const t=n;if(typeof t.toJSON=="function")try{const r=t.toJSON();if(r!==n)return a(r,e)}catch{return}if(Array.isArray(n)){if(e.has(n))return;e.add(n);const r=[];for(const s of n){const c=a(s,e);c!==void 0&&r.push(c)}return e.delete(n),r}if(typeof ArrayBuffer<"u"){if(ArrayBuffer.isView(n)){if(n instanceof DataView){const r=n,s=new Uint8Array(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength));return Array.from(s)}return Array.from(n)}if(n instanceof ArrayBuffer)return Array.from(new Uint8Array(n))}if(n instanceof Map){if(e.has(n))return;e.add(n);const r=[];for(const[s,c]of n.entries()){const f=a(s,e),m=a(c,e);f!==void 0&&m!==void 0&&r.push([f,m])}return e.delete(n),r}if(n instanceof Set){if(e.has(n))return;e.add(n);const r=[];for(const s of n.values()){const c=a(s,e);c!==void 0&&r.push(c)}return e.delete(n),r}if(K(n)||e.has(n))return;e.add(n);const p={};for(const r of Object.keys(n)){const s=a(n[r],e);s!==void 0&&(p[r]=s)}return e.delete(n),p}}},U=n=>{const e={},o=new WeakSet;for(const t in n){if(!Object.prototype.hasOwnProperty.call(n,t)||M.has(t))continue;const p=n[t],r=a(p,o);r!==void 0&&(e[t]=r)}return e};export const ssr=(n,e)=>{const o={count:0,cCounter:0,components:{},props:{}};let t=P(n,e,o);t=t.replace(/\s[a-z]+="\$wcREMOVE\$"/g,"");const p={},r=o.components;for(const s in r){const f=r[s].options.generatedCSS;f&&(p[s]=f.replace(/\s\s+/g," ").replace(/\t/g,"").replace(/\n/g,""))}return{html:t,css:p,props:o.props}};const P=(n,e,o)=>{let t="";const{generatedCSS:p,styles:r,shadow:s}=n.options,c={...e,styles:r},f=n.componentName;o.props[f]||(o.props[f]=[]);const m=o.props[f].length;t+=`<${f} wompo-hydrate="${m}"`;for(const i in c){if(!Object.prototype.hasOwnProperty.call(c,i)||i==="children"||i==="styles"||i==="ref"||i.startsWith("on"))continue;const d=c[i],$=d!==Object(d);typeof d!="function"&&$&&i!=="title"&&(t+=` ${i}="${d}"`)}t+=">",s&&(t+='<template shadowrootmode="open">'),p&&(t+=`<link rel="stylesheet" href="/${f}.css" />`),o.components[f]=n;const w=L(c),k=x(w);let u;try{u=n.call(w,c)}finally{B(k)}if(u==null)return"";const N=J(u)?u:I(u);o.props[f].push(U(c));let y=R(N,o);y=y.replace(/<([a-z]*-[a-z]*)(.*?)>/gs,(i,d,$)=>i.endsWith("/>")?`<${d}${$.substring(0,$.length-1)}></${d}>`:i);let b=0,l="";const g=[];y=y.replace(/<\/?([a-z]+?-[a-z]+?)\s?(?:\s.*?)?>/gs,(i,d)=>{if(!O[d])return i;if(i[1]!=="/"){if(d===l)b++;else if(!l){l=d;const h=i+`<?$CWC${g.length}>`;return b++,h}}else if(l&&d===l&&(b--,!b)){const h=`</?$CWC${g.length}>`+i;return l="",g.push(g.length),h}return i});for(const i of g){const d=new RegExp(`<([a-z]+-[a-z]+)([^>]*?)><\\?\\$CWC${i}>(.*?)<\\/\\?\\$CWC${i}>`,"gs");y=y.replace(d,($,h,j,z)=>{const V=O[h],C={};C.children={_$wompoChildren:!0,nodes:z};const H=j.matchAll(/\s?(.*?)="(.*?)"/gs);let S;for(;!(S=H.next()).done;){const[q,_,W]=S.value;if(W.match(/\$wc(.*?)\$/)){const E=o[W];C[_]=E}else C[_]=W}return P(V,C,o)})}return t+=y,s&&(t+="</template>"),t+=`</${f}>`,t},R=(n,e)=>{let o="";for(let t=0;t<n.parts.length;t++){let p=n.parts[t];const r=n.values[t];o+=p,o+=A(p,r,e)}return o},A=(n,e,o)=>{let t="";const p=e===!1||e===void 0||e===null,r=e!==Object(e);if(n.endsWith("=")){if(p)return t+='"$wcREMOVE$"',t;if(r)t+=`"${e}"`;else if(n.endsWith(" style=")){let s="";const c=Object.keys(e);for(const f of c){let m=e[f],w=f.replace(/[A-Z]/g,k=>"-"+k.toLowerCase());typeof m=="number"&&(m=`${m}px`),s+=`${w}:${m};`}t+=`"${s}"`}else{const s=`$wc${o.count}$`;t+=`"${s}"`,o[s]=e,o.count++}return t}if(p)return t;if(e._$wompoF)return t+=e.componentName,t;if(e._$wompoChildren)return t+=e.nodes,o.cCounter++,t;if(r)return t+=e,t;if(Array.isArray(e)){for(const s of e)t+=A(n,s,o);return t}return e._$wompoHtml?R(e,o):t};
