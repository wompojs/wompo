{
  "version": 3,
  "sources": ["../../ts/ssr/index.ts"],
  "sourcesContent": ["import { type RenderHtml, type WompComponent, type WompProps, registeredComponents } from '../womp';\n\n/* \n================================================\nSSR\n================================================\n*/\ntype SsrDataObject = {\n\tcount: number;\n\tcCounter: number;\n\tcomponents: {\n\t\t[key: string]: WompComponent;\n\t};\n\tprops: {\n\t\t[key: string]: WompProps[];\n\t};\n\t[key: string]: any;\n};\n\nexport const ssr = (Component: WompComponent, props: WompProps) => {\n\tconst ssrData: SsrDataObject = {\n\t\tcount: 0,\n\t\tcCounter: 0,\n\t\tcomponents: {},\n\t\tprops: {},\n\t};\n\tlet htmlString = ssRenderComponent(Component, props, ssrData);\n\thtmlString = htmlString.replace(/\\s[a-z]+=\"\\$wcREMOVE\\$\"/g, '');\n\tconst css: { [key: string]: string } = {};\n\tconst components = ssrData.components;\n\tfor (const comp in components) {\n\t\tconst component = components[comp];\n\t\tconst compCss = component.options.generatedCSS;\n\t\tif (compCss) css[comp] = compCss.replace(/\\s\\s+/g, ' ').replace(/\\t/g, '').replace(/\\n/g, '');\n\t}\n\treturn {\n\t\thtml: htmlString,\n\t\tcss: css,\n\t\tprops: ssrData.props,\n\t};\n};\n\nconst ssRenderComponent = (Component: WompComponent, props: WompProps, ssrData: SsrDataObject) => {\n\tlet html = '';\n\tconst { generatedCSS, styles, shadow } = Component.options;\n\tprops.styles = styles;\n\tconst componentName = Component.componentName;\n\tif (!ssrData.props[componentName]) ssrData.props[componentName] = [];\n\thtml += `<${componentName} womp-hydrate=\"${ssrData.props[componentName].length}\"`;\n\tfor (const prop in props) {\n\t\tconst value = props[prop as keyof WompProps];\n\t\tconst isPrimitive = value !== Object(value);\n\t\tif (isPrimitive && prop !== 'title') html += ` ${prop}=\"${value}\"`;\n\t}\n\thtml += '>';\n\t// Add shadow\n\tif (shadow) html += `<template shadowrootmode=\"open\">`;\n\t// Append styles\n\tif (generatedCSS) html += `<link rel=\"stylesheet\" href=\"/${componentName}.css\" />`;\n\tssrData.components[componentName] = Component;\n\tconst template = Component(props);\n\tdelete props.children; //! Maybe remove when implementing hydration\n\tssrData.props[componentName].push(props);\n\t// Render component\n\tlet toRender = generateSsHtml(template, ssrData);\n\t// Replace self-closing tags\n\ttoRender = toRender.replace(/<([a-z]*-[a-z]*)(.*?)>/gs, (match, name, attrs) =>\n\t\tmatch.endsWith('/>') ? `<${name}${attrs.substring(0, attrs.length - 1)}></${name}>` : match\n\t);\n\t// Search for other custom components. It'll only manage \"first-level\" components, not the nested\n\t// ones. This will allow a good control of recursion.\n\tlet counter = 0;\n\tlet pending: string = '';\n\tconst components: number[] = [];\n\ttoRender = toRender.replace(/<\\/?([a-z]+?-[a-z]+?)\\s?(?:\\s.*?)?>/gs, (match, name) => {\n\t\tconst component = registeredComponents[name];\n\t\tif (!component) return match;\n\t\tif (match[1] !== '/') {\n\t\t\tif (name === pending) {\n\t\t\t\tcounter++;\n\t\t\t} else if (!pending) {\n\t\t\t\tpending = name;\n\t\t\t\tconst res = match + `<?$CWC${components.length}>`;\n\t\t\t\tcounter++;\n\t\t\t\treturn res;\n\t\t\t}\n\t\t} else if (pending) {\n\t\t\tif (name === pending) {\n\t\t\t\tcounter--;\n\t\t\t\tif (!counter) {\n\t\t\t\t\tconst res = `</?$CWC${components.length}>` + match;\n\t\t\t\t\tpending = '';\n\t\t\t\t\tcomponents.push(components.length);\n\t\t\t\t\treturn res;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn match;\n\t});\n\t// Render first-layer custom components\n\tfor (const id of components) {\n\t\tconst regex = new RegExp(\n\t\t\t`<([a-z]+-[a-z]+)([^>]*?)><\\\\?\\\\$CWC${id}>(.*?)<\\\\/\\\\?\\\\$CWC${id}>`,\n\t\t\t'gs'\n\t\t);\n\t\ttoRender = toRender.replace(regex, (_, name, attrs, children) => {\n\t\t\tconst Component = registeredComponents[name];\n\t\t\tconst componentProps: WompProps = {};\n\t\t\tcomponentProps.children = {\n\t\t\t\t_$wompChildren: true,\n\t\t\t\tnodes: children as any,\n\t\t\t};\n\t\t\tconst attributes = attrs.matchAll(/\\s?(.*?)=\"(.*?)\"/gs);\n\t\t\tlet attr;\n\t\t\twhile (!(attr = attributes.next()).done) {\n\t\t\t\tconst [_, attrName, attrValue] = attr.value;\n\t\t\t\tif (attrValue.match(/\\$wc(.*?)\\$/)) {\n\t\t\t\t\tconst value = ssrData[attrValue];\n\t\t\t\t\t(componentProps as any)[attrName] = value;\n\t\t\t\t} else {\n\t\t\t\t\t(componentProps as any)[attrName] = attrValue;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ssRenderComponent(Component, componentProps, ssrData);\n\t\t});\n\t}\n\thtml += toRender;\n\t// Close shadow\n\tif (shadow) html += `</template>`;\n\t// Close component\n\thtml += `</${componentName}>`;\n\treturn html;\n};\n\nconst generateSsHtml = (template: RenderHtml, ssrData: SsrDataObject) => {\n\tlet html = '';\n\tfor (let i = 0; i < template.parts.length; i++) {\n\t\tlet part = template.parts[i];\n\t\tconst value = template.values[i];\n\t\thtml += part;\n\t\thtml += handleSsValue(part, value, ssrData);\n\t}\n\treturn html;\n};\n\nconst handleSsValue = (part: string, value: any, ssrData: SsrDataObject) => {\n\tlet html = '';\n\tconst shouldBeRemoved = value === false || value === undefined || value === null;\n\tconst isPrimitive = value !== Object(value);\n\t// Is attribute\n\tif (part.endsWith('=')) {\n\t\tif (shouldBeRemoved) {\n\t\t\thtml += `\"$wcREMOVE$\"`;\n\t\t\treturn html;\n\t\t}\n\t\tif (isPrimitive) {\n\t\t\thtml += `\"${value}\"`;\n\t\t} else {\n\t\t\tif (part.endsWith(' style=')) {\n\t\t\t\t// If it's a style attribute and it's an object\n\t\t\t\tlet styleString = '';\n\t\t\t\tconst styles = Object.keys(value);\n\t\t\t\tfor (const key of styles) {\n\t\t\t\t\tlet styleValue = value[key];\n\t\t\t\t\tlet styleKey = key.replace(/[A-Z]/g, (letter) => '-' + letter.toLowerCase());\n\t\t\t\t\tif (typeof styleValue === 'number') styleValue = `${styleValue}px`;\n\t\t\t\t\tstyleString += `${styleKey}:${styleValue};`;\n\t\t\t\t}\n\t\t\t\thtml += `\"${styleString}\"`;\n\t\t\t} else {\n\t\t\t\tconst identifier = `$wc${ssrData.count}$`;\n\t\t\t\thtml += `\"${identifier}\"`;\n\t\t\t\tssrData[identifier] = value;\n\t\t\t\tssrData.count++;\n\t\t\t}\n\t\t}\n\t\treturn html;\n\t}\n\t// Not an attribute: it's a falsy node (to remove)\n\tif (shouldBeRemoved) {\n\t\treturn html;\n\t}\n\t// Is Womp Component\n\tif (value._$wompF) {\n\t\thtml += value.componentName;\n\t\treturn html;\n\t}\n\t// Is children\n\tif (value._$wompChildren) {\n\t\thtml += value.nodes;\n\t\tssrData.cCounter++;\n\t\treturn html;\n\t}\n\t// Is node\n\tif (isPrimitive) {\n\t\thtml += value;\n\t\treturn html;\n\t}\n\t// Is array\n\tif (Array.isArray(value)) {\n\t\tfor (const val of value) {\n\t\t\thtml += handleSsValue(part, val, ssrData);\n\t\t}\n\t\treturn html;\n\t}\n\t// Is template\n\tif (value._$wompHtml) {\n\t\treturn generateSsHtml(value, ssrData);\n\t}\n\n\treturn html;\n};\n\n//! Find weak points (e.g. if you put a \">\" in the attributes).\n//! Dynamic composed attr doesnt work on custom elements (e.g. title=\"N. ${counter}\")\n//! Deeply test ALL Regexes: putting line breaks, and stuff.\n//! Maybe review the CSS Generation. Is it OK?\n"],
  "mappings": "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",
  "names": ["Component", "_"]
}
