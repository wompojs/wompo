{
  "version": 3,
  "sources": ["../../ts/ssr/index.ts"],
  "sourcesContent": ["import {\n\ttype RenderHtml,\n\ttype WompoComponent,\n\ttype WompoProps,\n\tregisteredComponents,\n} from '../wompo.js';\n\n/* \n================================================\nSSR\n================================================\n*/\ntype SsrDataObject = {\n\tcount: number;\n\tcCounter: number;\n\tcomponents: {\n\t\t[key: string]: WompoComponent;\n\t};\n\tprops: {\n\t\t[key: string]: WompoProps[];\n\t};\n\t[key: string]: any;\n};\n\nexport const ssr = (Component: WompoComponent, props: WompoProps) => {\n\tconst ssrData: SsrDataObject = {\n\t\tcount: 0,\n\t\tcCounter: 0,\n\t\tcomponents: {},\n\t\tprops: {},\n\t};\n\tlet htmlString = ssRenderComponent(Component, props, ssrData);\n\thtmlString = htmlString.replace(/\\s[a-z]+=\"\\$wcREMOVE\\$\"/g, '');\n\tconst css: { [key: string]: string } = {};\n\tconst components = ssrData.components;\n\tfor (const comp in components) {\n\t\tconst component = components[comp];\n\t\tconst compCss = component.options.generatedCSS;\n\t\tif (compCss) css[comp] = compCss.replace(/\\s\\s+/g, ' ').replace(/\\t/g, '').replace(/\\n/g, '');\n\t}\n\treturn {\n\t\thtml: htmlString,\n\t\tcss: css,\n\t\tprops: ssrData.props,\n\t};\n};\n\nconst ssRenderComponent = (\n\tComponent: WompoComponent,\n\tprops: WompoProps,\n\tssrData: SsrDataObject\n) => {\n\tlet html = '';\n\tconst { generatedCSS, styles, shadow } = Component.options;\n\tprops.styles = styles;\n\tconst componentName = Component.componentName;\n\tif (!ssrData.props[componentName]) ssrData.props[componentName] = [];\n\thtml += `<${componentName} wompo-hydrate=\"${ssrData.props[componentName].length}\"`;\n\tfor (const prop in props) {\n\t\tconst value = props[prop as keyof WompoProps];\n\t\tconst isPrimitive = value !== Object(value);\n\t\tif (isPrimitive && prop !== 'title') html += ` ${prop}=\"${value}\"`;\n\t}\n\thtml += '>';\n\t// Add shadow\n\tif (shadow) html += `<template shadowrootmode=\"open\">`;\n\t// Append styles\n\tif (generatedCSS) html += `<link rel=\"stylesheet\" href=\"/${componentName}.css\" />`;\n\tssrData.components[componentName] = Component;\n\tconst template = Component(props);\n\tdelete props.children; //! Maybe remove when implementing hydration\n\tssrData.props[componentName].push(props);\n\t// Render component\n\tlet toRender = generateSsHtml(template, ssrData);\n\t// Replace self-closing tags\n\ttoRender = toRender.replace(/<([a-z]*-[a-z]*)(.*?)>/gs, (match, name, attrs) =>\n\t\tmatch.endsWith('/>') ? `<${name}${attrs.substring(0, attrs.length - 1)}></${name}>` : match\n\t);\n\t// Search for other custom components. It'll only manage \"first-level\" components, not the nested\n\t// ones. This will allow a good control of recursion.\n\tlet counter = 0;\n\tlet pending: string = '';\n\tconst components: number[] = [];\n\ttoRender = toRender.replace(/<\\/?([a-z]+?-[a-z]+?)\\s?(?:\\s.*?)?>/gs, (match, name) => {\n\t\tconst component = registeredComponents[name];\n\t\tif (!component) return match;\n\t\tif (match[1] !== '/') {\n\t\t\tif (name === pending) {\n\t\t\t\tcounter++;\n\t\t\t} else if (!pending) {\n\t\t\t\tpending = name;\n\t\t\t\tconst res = match + `<?$CWC${components.length}>`;\n\t\t\t\tcounter++;\n\t\t\t\treturn res;\n\t\t\t}\n\t\t} else if (pending) {\n\t\t\tif (name === pending) {\n\t\t\t\tcounter--;\n\t\t\t\tif (!counter) {\n\t\t\t\t\tconst res = `</?$CWC${components.length}>` + match;\n\t\t\t\t\tpending = '';\n\t\t\t\t\tcomponents.push(components.length);\n\t\t\t\t\treturn res;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn match;\n\t});\n\t// Render first-layer custom components\n\tfor (const id of components) {\n\t\tconst regex = new RegExp(\n\t\t\t`<([a-z]+-[a-z]+)([^>]*?)><\\\\?\\\\$CWC${id}>(.*?)<\\\\/\\\\?\\\\$CWC${id}>`,\n\t\t\t'gs'\n\t\t);\n\t\ttoRender = toRender.replace(regex, (_, name, attrs, children) => {\n\t\t\tconst Component = registeredComponents[name];\n\t\t\tconst componentProps: WompoProps = {};\n\t\t\tcomponentProps.children = {\n\t\t\t\t_$wompoChildren: true,\n\t\t\t\tnodes: children as any,\n\t\t\t};\n\t\t\tconst attributes = attrs.matchAll(/\\s?(.*?)=\"(.*?)\"/gs);\n\t\t\tlet attr;\n\t\t\twhile (!(attr = attributes.next()).done) {\n\t\t\t\tconst [_, attrName, attrValue] = attr.value;\n\t\t\t\tif (attrValue.match(/\\$wc(.*?)\\$/)) {\n\t\t\t\t\tconst value = ssrData[attrValue];\n\t\t\t\t\t(componentProps as any)[attrName] = value;\n\t\t\t\t} else {\n\t\t\t\t\t(componentProps as any)[attrName] = attrValue;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ssRenderComponent(Component, componentProps, ssrData);\n\t\t});\n\t}\n\thtml += toRender;\n\t// Close shadow\n\tif (shadow) html += `</template>`;\n\t// Close component\n\thtml += `</${componentName}>`;\n\treturn html;\n};\n\nconst generateSsHtml = (template: RenderHtml, ssrData: SsrDataObject) => {\n\tlet html = '';\n\tfor (let i = 0; i < template.parts.length; i++) {\n\t\tlet part = template.parts[i];\n\t\tconst value = template.values[i];\n\t\thtml += part;\n\t\thtml += handleSsValue(part, value, ssrData);\n\t}\n\treturn html;\n};\n\nconst handleSsValue = (part: string, value: any, ssrData: SsrDataObject) => {\n\tlet html = '';\n\tconst shouldBeRemoved = value === false || value === undefined || value === null;\n\tconst isPrimitive = value !== Object(value);\n\t// Is attribute\n\tif (part.endsWith('=')) {\n\t\tif (shouldBeRemoved) {\n\t\t\thtml += `\"$wcREMOVE$\"`;\n\t\t\treturn html;\n\t\t}\n\t\tif (isPrimitive) {\n\t\t\thtml += `\"${value}\"`;\n\t\t} else {\n\t\t\tif (part.endsWith(' style=')) {\n\t\t\t\t// If it's a style attribute and it's an object\n\t\t\t\tlet styleString = '';\n\t\t\t\tconst styles = Object.keys(value);\n\t\t\t\tfor (const key of styles) {\n\t\t\t\t\tlet styleValue = value[key];\n\t\t\t\t\tlet styleKey = key.replace(/[A-Z]/g, (letter) => '-' + letter.toLowerCase());\n\t\t\t\t\tif (typeof styleValue === 'number') styleValue = `${styleValue}px`;\n\t\t\t\t\tstyleString += `${styleKey}:${styleValue};`;\n\t\t\t\t}\n\t\t\t\thtml += `\"${styleString}\"`;\n\t\t\t} else {\n\t\t\t\tconst identifier = `$wc${ssrData.count}$`;\n\t\t\t\thtml += `\"${identifier}\"`;\n\t\t\t\tssrData[identifier] = value;\n\t\t\t\tssrData.count++;\n\t\t\t}\n\t\t}\n\t\treturn html;\n\t}\n\t// Not an attribute: it's a falsy node (to remove)\n\tif (shouldBeRemoved) {\n\t\treturn html;\n\t}\n\t// Is Wompo Component\n\tif (value._$wompoF) {\n\t\thtml += value.componentName;\n\t\treturn html;\n\t}\n\t// Is children\n\tif (value._$wompoChildren) {\n\t\thtml += value.nodes;\n\t\tssrData.cCounter++;\n\t\treturn html;\n\t}\n\t// Is node\n\tif (isPrimitive) {\n\t\thtml += value;\n\t\treturn html;\n\t}\n\t// Is array\n\tif (Array.isArray(value)) {\n\t\tfor (const val of value) {\n\t\t\thtml += handleSsValue(part, val, ssrData);\n\t\t}\n\t\treturn html;\n\t}\n\t// Is template\n\tif (value._$wompoHtml) {\n\t\treturn generateSsHtml(value, ssrData);\n\t}\n\n\treturn html;\n};\n\n// TODO Find weak points (e.g. if you put a \">\" in the attributes).\n// TODO Dynamic composed attr doesnt work on custom elements (e.g. title=\"N. ${counter}\")\n// TODO Deeply test ALL Regexes: putting line breaks, and stuff.\n// TODO Maybe review the CSS Generation. Is it OK?\n"],
  "mappings": "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",
  "names": ["registeredComponents", "Component", "props", "ssrData", "htmlString", "ssRenderComponent", "css", "components", "comp", "compCss", "html", "generatedCSS", "styles", "shadow", "componentName", "prop", "value", "template", "toRender", "generateSsHtml", "match", "name", "attrs", "counter", "pending", "res", "id", "regex", "_", "children", "componentProps", "attributes", "attr", "attrName", "attrValue", "i", "part", "handleSsValue", "shouldBeRemoved", "isPrimitive", "styleString", "key", "styleValue", "styleKey", "letter", "identifier", "val"]
}
